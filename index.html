<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì∏ Foto para Curr√≠culo Lattes</title>

  <!-- Bootstrap Icons CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    /* style.css - mobile-first, BEM naming, flexbox centering */
    :root{
      --bg:#f7f9fc;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#3b82f6;
      --shadow: 0 6px 18px rgba(22, 38, 84, 0.06);
      --radius:12px;
      --max-width:780px;
      --limit-width:360px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .app{
      width:100%;
      max-width:var(--max-width);
      background:transparent;
    }

    .header{
      position:sticky;
      top:12px;
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .header__title{
      font-size:1.1rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      margin-bottom:14px;
    }

    .grid{
      display:grid;
      gap:14px;
    }

    /* two-column on wider screens */
    @media(min-width:780px){
      .grid{ grid-template-columns:1fr 1fr; }
    }

    .section__title{
      margin:0 0 8px 0;
      font-weight:600;
      font-size:0.95rem;
    }
    .card{
      border-radius:10px;
      padding:12px;
      background:#fbfcff;
      border:1px solid #eef2ff;
    }

    .camera-frame{
      width:100%;
      max-width:300px;
      aspect-ratio:3/4; /* 3x4 frame */
      background:#e6eefc;
      border-radius:8px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      margin-bottom:10px;
    }
    video, canvas, .preview-img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:0;
      padding:10px 12px;
      border-radius:10px;
      background:var(--accent);
      color:white;
      cursor:pointer;
      font-weight:600;
      font-size:0.9rem;
    }
    .btn.secondary{
      background:#e6eefc;
      color:var(--accent);
      border:1px solid rgba(59,130,246,0.12);
    }
    .btn:focus{ outline:3px solid rgba(59,130,246,0.14) }

    .file-drop{
      border:2px dashed #e6eefc;
      border-radius:8px;
      padding:12px;
      text-align:center;
      background:#fff;
    }
    .muted{ color:var(--muted); font-size:0.9rem }

    .preview-wrap{ display:flex; flex-direction:column; gap:8px; align-items:center; }

    footer{
      margin-top:8px;
      text-align:center;
      font-size:0.9rem;
      color:var(--muted);
    }
    .footer-icons{ margin-top:6px; display:flex; gap:10px; justify-content:center; }
    .footer-icons a{ color:var(--muted); font-size:1.1rem; text-decoration:none; }
    a{ color:var(--accent) }

    /* Accessibility */
    .sr-only{ position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }

    /* limit layout width on very small devices for camera preview */
    .main-row{ display:flex; justify-content:center; }
    .panel--center{ max-width:var(--limit-width); margin:0 auto }

    /* small helper */
    .info{ font-size:0.85rem; color:var(--muted) }
  </style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="app-title">
    <header class="header" role="banner">
      <h1 id="app-title" class="header__title">üì∏ Foto para Curr√≠culo Lattes</h1>
    </header>

    <main class="grid" role="main" aria-live="polite">
      <!-- Capture section -->
      <section class="panel panel--center" aria-labelledby="capture-title">
        <h2 id="capture-title" class="section__title">Tirar Foto (3x4)</h2>
        <div class="card" role="region" aria-label="Captura de foto">
          <div class="camera-frame" id="camera-frame" aria-hidden="false">
            <video id="video" autoplay playsinline></video>
            <canvas id="camera-canvas" style="display:none"></canvas>
            <img id="capture-preview" class="preview-img" alt="Preview da foto" style="display:none"/>
          </div>

          <div class="controls" style="margin-top:8px">
            <button id="btn-open" class="btn" type="button"><i class="bi bi-camera"></i> Tirar Foto</button>
            <button id="btn-capture" class="btn secondary" type="button" disabled><i class="bi bi-camera-fill"></i> Capturar</button>
            <button id="btn-retake" class="btn secondary" type="button" disabled><i class="bi bi-arrow-counterclockwise"></i> Repetir</button>
            <button id="btnToggleCamera"><i class="bi bi-camera-reverse"></i> C. Traseira</button>
            <button id="btn-download-capture" class="btn" type="button" style="display:none"><i class="bi bi-download"></i> Baixar (‚â§ 69KB)</button>
          </div>

          <p class="info" style="margin-top:8px">A c√¢mera √© dimensionada para 3x4. A imagem de download ser√° otimizada para ‚â§ 69KB sem deformar.</p>
        </div>
      </section>

      <!-- Compress section -->
      <section class="panel panel--center" aria-labelledby="compress-title">
        <h2 id="compress-title" class="section__title">Reduzir Imagem para 69KB</h2>
        <div class="card" role="region" aria-label="Compress√£o de imagem">
          <div class="file-drop" id="drop-area">
            <p class="muted">Arraste e solte uma imagem aqui ou use o bot√£o</p>
            <input id="file-input" type="file" accept="image/*" style="display:none" />
            <div style="margin-top:8px">
              <button id="btn-choose" class="btn secondary" type="button"><i class="bi bi-upload"></i> Escolher imagem</button>
            </div>
          </div>

          <div class="preview-wrap" id="upload-preview" style="margin-top:12px; display:none">
            <div class="camera-frame" style="max-width:260px">
              <img id="uploaded-img" class="preview-img" alt="Preview da imagem enviada" />
            </div>
            <div class="controls">
              <button id="btn-download-upload" class="btn" type="button"><i class="bi bi-download"></i> Baixar (‚â§ 69KB)</button>
            </div>
            <p id="upload-info" class="info"></p>
          </div>
        </div>
      </section>
    </main>

    <footer role="contentinfo">
      <p>üì∏ Foto para Curr√≠culo Lattes ‚Äî Desenvolvido por
        <a href="https://github.com/Leymarck/" target="_blank" rel="noopener">Leymarck</a>
      </p>
      <div class="footer-icons" aria-hidden="false">
        <a href="#" title="Instagram"><i class="bi bi-instagram"></i></a>
        <a href="#" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
      </div>
    </footer>
  </div>

  <!-- JavaScript (modular, SRP) -->
  <script>
    /* utils.js - fun√ß√µes utilit√°rias simples e curtas */
    const Utils = (function(){
      const LIMIT_BYTES = 69 * 1024; // 69KB target

      function formatBytes(bytes){
        if(bytes < 1024) return bytes + ' B';
        if(bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
        return (bytes/(1024*1024)).toFixed(2) + ' MB';
      }

      function triggerDownload(blob, filename='foto-lattes.jpg'){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
      }

      function blobSize(blob){
        return blob.size;
      }

      return { LIMIT_BYTES, formatBytes, triggerDownload, blobSize };
    })();

    /* compress.js - compress√£o de imagens existentes */
    const CompressModule = (function(U){
      // compressImageTo69KB(image: HTMLImageElement) -> Promise<Blob>
      async function compressImageTo69KB(imgEl){
        // start from original natural size
        let w = imgEl.naturalWidth;
        let h = imgEl.naturalHeight;
        const aspect = w / h;

        // create canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // helper to get blob for quality and size
        async function toBlobWithQuality(width, height, quality){
          canvas.width = Math.round(width);
          canvas.height = Math.round(height);
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);
          return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
        }

        // First try: keep dimensions, iterate quality down
        let quality = 0.92;
        let blob = await toBlobWithQuality(w,h,quality);
        while(blob && blob.size > U.LIMIT_BYTES && quality > 0.2){
          quality -= 0.07;
          blob = await toBlobWithQuality(w,h,quality);
        }

        // If still too big, reduce dimensions gradually (keeping proportion)
        let maxReduction = 0.9;
        while(blob && blob.size > U.LIMIT_BYTES && (w > 200 && h > 200)){
          // reduce by 10% steps until limit reached
          w = Math.round(w * 0.9);
          h = Math.round(w / aspect); // maintain proportion
          // try with moderate quality
          blob = await toBlobWithQuality(w,h,Math.max(0.6, quality));
          // guard to avoid infinite loop
          maxReduction -= 0.1;
          if(maxReduction < -0.5) break;
        }

        // As fallback, keep compressing aggressively until below limit (rare)
        while(blob && blob.size > U.LIMIT_BYTES){
          const aggressiveQuality = 0.5;
          w = Math.round(w * 0.95);
          h = Math.round(w / aspect);
          blob = await toBlobWithQuality(Math.max(120,w), Math.max(120,h), aggressiveQuality);
          if(w <= 120) break;
        }

        return blob;
      }

      async function handleFileUpload(file){
        if(!file || !file.type.startsWith('image/')) throw new Error('Arquivo inv√°lido');
        const img = await loadImageFromFile(file);
        const blob = await compressImageTo69KB(img);
        return { blob, img };
      }

      function loadImageFromFile(file){
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = reader.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      return { handleFileUpload, compressImageTo69KB };
    })(Utils);

    /* camera.js - captura via getUserMedia, mant√©m 3x4 e reduz para ‚â§69KB */
    const CameraModule = (function(U, C){
      let stream = null;
      const constraints = { video: { facingMode: 'user' } }; // prefer front camera when available
      const video = document.getElementById('video');
      const canvas = document.getElementById('camera-canvas');
      const previewImg = document.getElementById('capture-preview');

      async function initCamera(){
        if(stream) return;
        try{
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          await video.play();
          // ensure video size matches our 3x4 frame: we will draw to canvas later
        }catch(err){
          console.error('Erro ao abrir c√¢mera', err);
          throw err;
        }
      }

      function stopCamera(){
        if(!stream) return;
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.pause();
        video.srcObject = null;
      }

      function capturePhoto(){
        // prepare canvas with 3:4 aspect ratio based on video size
        const targetWidth = 900; // base resolution (will be scaled later)
        const targetHeight = Math.round(targetWidth * 4 / 3); // 3x4 -> width:height = 3:4
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext('2d');

        // compute cropping to center the video feed into 3:4 canvas without distortion
        // videoWidth/Height may vary; draw centered crop
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        if(!vw || !vh) throw new Error('V√≠deo n√£o dispon√≠vel');

        // compute scale to fill canvas, cropping extra
        const scale = Math.max(canvas.width / vw, canvas.height / vh);
        const sw = Math.round(canvas.width / scale);
        const sh = Math.round(canvas.height / scale);
        const sx = Math.round((vw - sw) / 2);
        const sy = Math.round((vh - sh) / 2);

        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
        // show preview
        previewImg.src = canvas.toDataURL('image/jpeg', 0.9);
        previewImg.style.display = 'block';
        video.style.display = 'none';
        return canvas;
      }

      async function getCompressedCaptureBlob(){
        // compress canvas content to <= limit using similar approach as CompressModule
        // create image element from canvas data
        const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
        const img = new Image();
        img.src = dataUrl;
        await img.decode();
        // use CompressModule logic: we can call compressImageTo69KB passing img
        const blob = await C.compressImageTo69KB(img);
        return blob;
      }

      return { initCamera, stopCamera, capturePhoto, getCompressedCaptureBlob };
    })(Utils, CompressModule);

    /* App wiring: listeners and small orchestration (no business logic inside DOM handlers) */
    (function(U, Camera, Compress){
      // DOM elems
      const btnOpen = document.getElementById('btn-open');
      const btnCapture = document.getElementById('btn-capture');
      const btnRetake = document.getElementById('btn-retake');
      const btnDownloadCapture = document.getElementById('btn-download-capture');

      const btnChoose = document.getElementById('btn-choose');
      const fileInput = document.getElementById('file-input');
      const dropArea = document.getElementById('drop-area');

      const uploadPreviewWrap = document.getElementById('upload-preview');
      const uploadedImgEl = document.getElementById('uploaded-img');
      const btnDownloadUpload = document.getElementById('btn-download-upload');
      const uploadInfo = document.getElementById('upload-info');

      const video = document.getElementById('video');
      const capturePreview = document.getElementById('capture-preview');

      // open camera
      btnOpen.addEventListener('click', async () => {
        try{
          await Camera.initCamera();
          video.style.display = 'block';
          capturePreview.style.display = 'none';
          btnCapture.disabled = false;
          btnRetake.disabled = true;
          btnDownloadCapture.style.display = 'none';
        }catch(e){
          alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique permiss√µes.');
        }
      });

      // capture
      btnCapture.addEventListener('click', () => {
        try{
          Camera.capturePhoto();
          btnRetake.disabled = false;
          btnDownloadCapture.style.display = 'inline-flex';
          btnCapture.disabled = true;
        }catch(e){
          console.error(e);
          alert('Erro ao capturar foto');
        }
      });

      // retake
      btnRetake.addEventListener('click', () => {
        // show video again for new capture
        const videoEl = document.getElementById('video');
        videoEl.style.display = 'block';
        capturePreview.style.display = 'none';
        btnCapture.disabled = false;
        btnRetake.disabled = true;
        btnDownloadCapture.style.display = 'none';
      });

      // download captured photo
      btnDownloadCapture.addEventListener('click', async () => {
        try{
          const blob = await Camera.getCompressedCaptureBlob();
          if(!blob) throw new Error('Falha na compress√£o');
          U.triggerDownload(blob, 'foto-lattes-captura.jpg');
        }catch(e){
          console.error(e);
          alert('Erro ao preparar o download da foto capturada.');
        }
      });

      // choose file
      btnChoose.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', async (ev) => {
        const file = ev.target.files && ev.target.files[0];
        if(!file) return;
        await handleUploadFile(file);
      });

      // drag & drop
      ;['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, (e)=>{ e.preventDefault(); dropArea.style.borderColor = '#cfe2ff'; }));
      ;['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, (e)=>{ e.preventDefault(); dropArea.style.borderColor = '#e6eefc'; }));
      dropArea.addEventListener('drop', async (e) => {
        const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(!file) return;
        await handleUploadFile(file);
      });

      async function handleUploadFile(file){
        try{
          // process file
          const { blob, img } = await Compress.handleFileUpload(file);
          // show preview: create objectURL from blob for display
          const url = URL.createObjectURL(blob);
          uploadedImgEl.src = url;
          uploadPreviewWrap.style.display = 'flex';
          uploadInfo.textContent = `Tamanho final: ${U.formatBytes(blob.size)} (limite ${U.formatBytes(U.LIMIT_BYTES)})`;
          // store blob on button click
          btnDownloadUpload.onclick = ()=> U.triggerDownload(blob, 'foto-lattes-compress.jpg');
        }catch(err){
          console.error(err);
          alert('Falha ao processar arquivo. Envie uma imagem v√°lida.');
        }
      }

      // when navigating away, stop camera tracks
      window.addEventListener('beforeunload', () => {
        try{ Camera.stopCamera(); }catch(e){}
      });

    })(Utils, CameraModule, CompressModule);

// Vari√°veis globais adicionadas
const btnToggleCamera = document.getElementById('btnToggleCamera');
let currentStream;
let useFrontCamera = true;

// Fun√ß√£o initCamera modificada
async function initCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }
  const constraints = {
    video: {
      facingMode: useFrontCamera ? 'user' : 'environment',
      aspectRatio: 3/4
    }
  };
  try {
    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = currentStream;
  } catch (err) {
    alert('Erro ao acessar c√¢mera: ' + err.message);
  }
}

// Novo event listener para alternar c√¢mera
btnToggleCamera.addEventListener('click', async () => {
  useFrontCamera = !useFrontCamera;
  btnToggleCamera.innerHTML = `<i class="bi bi-camera-reverse"></i> ${useFrontCamera ? 'C. Traseira' : 'C. Frontal'}`;
  await initCamera();
});

// Pequena adi√ß√£o no bot√£o Repetir (mostrar/esconder)
btnRepeat.addEventListener('click', () => {
  video.hidden = false;
  canvas.hidden = true;
  btnCapture.hidden = false;
  btnRepeat.hidden = true;
  btnDownload.hidden = true;
  btnToggleCamera.hidden = true; // üî∏ linha adicionada
});


  </script>
</body>
</html>
